<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `src\main.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>main.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../normalize.css"><link rel="stylesheet" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../ayu.css" disabled><link rel="stylesheet" href="../../dark.css" disabled><link rel="stylesheet" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script defer src="../../source-script.js"></script><script defer src="../../source-files.js"></script><script defer src="../../main.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"></nav><main><div class="width-limiter"><nav class="sub"><a class="sub-logo-container" href="../../wave2text/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><form class="search-form"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></form></nav><section id="main-content" class="content"><div class="example-wrap"><pre class="src-line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
</pre><pre class="rust"><code><span class="kw">use </span>serde::{Deserialize, Serialize};
<span class="kw">use </span>std::error::Error;
<span class="kw">use </span>std::fs;
<span class="kw">use </span>std::io;


<span class="kw">fn </span>main() {
    <span class="comment">// Splash screen
    </span><span class="kw">let </span>notice: <span class="kw-2">&amp;</span>str = <span class="string">r#&quot;wave2text  Copyright (C) 2022  Tom Su
    This program comes with ABSOLUTELY NO WARRANTY.
    This is free software, and you are welcome to redistribute it under certain
    conditions.
    See LICENSE.txt for details.
    
    &quot;#</span>;
    <span class="kw">let </span>logo: <span class="kw-2">&amp;</span>str = <span class="string">r#&quot;
       _          _   ___       _____   _____
      / \        / | |   |    _|     | |     \
    -&#39;   \  /\  /  |_|   |   |       | |      `-
          \/  \/         |___|       |_|
    
    &quot;#</span>;
    <span class="macro">println!</span>(<span class="string">&quot;{}{}&quot;</span>, notice, logo);

    <span class="comment">// Load settings from JSON file and get the pulse shape
    </span><span class="kw">let </span>settings: Settings = <span class="kw">match </span>get_settings(<span class="string">&quot;settings.json&quot;</span>) {
        <span class="prelude-val">Ok</span>(json) =&gt; json,
        <span class="prelude-val">Err</span>(error) =&gt; {
            <span class="macro">println!</span>(<span class="string">&quot;error loading ini.json: {}&quot;</span>, error);
            <span class="macro">println!</span>(<span class="string">&quot;Loading default settings...&quot;</span>);
            <span class="kw">let </span>default = Settings {
                pulse_path: String::from(<span class="string">&quot;pulse.txt&quot;</span>),
                sample_rate_hz: <span class="number">100000.0</span>,
                phase_duration_presets: Vec::new()
            };
            default
        },
    };
    <span class="kw">let </span><span class="kw-2">mut </span>sample_rate_hz: f64 = settings.sample_rate_hz;
    <span class="kw">let </span>pulse: Vec&lt;f64&gt; = <span class="kw">match </span>get_pulse_shape(<span class="kw-2">&amp;</span>settings.pulse_path) {
        <span class="prelude-val">Ok</span>(vec) =&gt; vec,
        <span class="prelude-val">Err</span>(error) =&gt; <span class="macro">panic!</span>(<span class="string">&quot;error loading pulse shape from file: {}&quot;</span>, error),
    };

    <span class="comment">// Define vectors to store waveform in
    </span><span class="kw">let </span><span class="kw-2">mut </span>waveform: Vec&lt;f64&gt; = Vec::new();
    <span class="kw">let </span><span class="kw-2">mut </span>wave_history: Vec&lt;String&gt; = Vec::new();

    <span class="comment">// Main program loop
    </span><span class="kw">loop </span>{
        <span class="kw">match </span>terminal_menu() {
            <span class="number">1 </span>=&gt; {
                <span class="kw">loop </span>{
                    <span class="macro">println!</span>(<span class="string">&quot;\nSampling rate (Hz): {}&quot;</span>, sample_rate_hz);
                    <span class="kw">if </span>confirm(<span class="string">&quot;Is this correct? Enter [Y] to confirm, or press any other button to enter a different sampling rate.&quot;</span>) {
                        <span class="kw">break
                    </span>} <span class="kw">else </span>{
                        <span class="comment">// TODO Query user to enter new sample rate
                        // TODO Query user if the new sample rate should be saved as default
                        </span><span class="kw">continue
                    </span>};
                }
                <span class="kw">let </span>pulse_temp = pulse.to_vec();
                (waveform, wave_history) = edit_waveform(wave_history, waveform, pulse_temp, sample_rate_hz);
            },
            <span class="number">2 </span>=&gt; <span class="macro">println!</span>(<span class="string">&quot;View waveform history.&quot;</span>),
            <span class="number">3 </span>=&gt; <span class="kw">if </span>confirm(<span class="string">&quot;Are you sure you want to clear the current waveform? Enter [Y] to confirm, or press any other button to return to the menu.&quot;</span>) {
                waveform.clear();
                wave_history.clear();
                <span class="macro">println!</span>(<span class="string">&quot;Waveform cleared.&quot;</span>);
            } <span class="kw">else </span>{<span class="kw">continue</span>},
            <span class="number">4 </span>=&gt; <span class="macro">println!</span>(<span class="string">&quot;Save waveform.&quot;</span>),
            <span class="number">5 </span>=&gt; <span class="kw">if </span>confirm(<span class="string">&quot;Are you sure you want to exit the program? Enter [Y] to confirm, or press any other button to return to the menu.&quot;</span>) {
                <span class="macro">println!</span>(<span class="string">&quot;Exiting...&quot;</span>);
                <span class="kw">break
            </span>} <span class="kw">else </span>{<span class="kw">continue</span>},
            <span class="kw">_ </span>=&gt; (),
        };
    };
}


<span class="doccomment">/// Loads saved settings from JSON file.
</span><span class="kw">fn </span>get_settings(file_path: <span class="kw-2">&amp;</span>str) -&gt; <span class="prelude-ty">Result</span>&lt;Settings, Box&lt;<span class="kw">dyn </span>Error&gt;&gt; {
    <span class="kw">let </span>ini_data: String = fs::read_to_string(file_path)<span class="question-mark">?</span>;
    <span class="kw">let </span>settings: Settings = serde_json::from_str(<span class="kw-2">&amp;</span>ini_data)<span class="question-mark">?</span>;

    <span class="prelude-val">Ok</span>(settings)
}

<span class="doccomment">/// Loads pulse shape from TXT file.
</span><span class="kw">fn </span>get_pulse_shape(file_path: <span class="kw-2">&amp;</span>str) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;f64&gt;, Box&lt;<span class="kw">dyn </span>Error&gt;&gt; {
    <span class="kw">let </span>pulse_string = fs::read_to_string(file_path)<span class="question-mark">?</span>;
    <span class="kw">let </span>pulse_string: Vec&lt;<span class="kw-2">&amp;</span>str&gt; = pulse_string.split(<span class="string">&quot;\r\n&quot;</span>).collect();
    <span class="kw">let </span><span class="kw-2">mut </span>pulse_shape: Vec&lt;f64&gt; = Vec::new();
    <span class="kw">for </span>sample <span class="kw">in </span><span class="number">0</span>..pulse_string.len() {
        pulse_shape.push(pulse_string[sample].parse::&lt;f64&gt;()<span class="question-mark">?</span>);
    }
    <span class="prelude-val">Ok</span>(pulse_shape)
}

<span class="doccomment">/// Brings up the menu and returns the input if valid.
</span><span class="kw">fn </span>terminal_menu() -&gt; u8 {
    <span class="comment">// Define strings for showing user options and how to call them.
    </span><span class="kw">let </span>menu: <span class="kw-2">&amp;</span>str = <span class="string">r#&quot;
What would you like to do?
    
    [1]. Edit waveform.
    [2]. View waveform history.
    [3]. Clear waveform.
    [4]. Save waveform.
    [5]. Exit program.
    &quot;#</span>;
    <span class="kw">let </span>input_prompt: <span class="kw-2">&amp;</span>str = <span class="string">&quot;Please enter a number 1-4.&quot;</span>;

    <span class="comment">// Print menu and get user input
    </span><span class="macro">println!</span>(<span class="string">&quot;{}\n{}&quot;</span>, menu, input_prompt);
    <span class="kw">loop </span>{
        <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
        <span class="kw">match </span>io::stdin().read_line(<span class="kw-2">&amp;mut </span>input) {
            <span class="prelude-val">Ok</span>(<span class="kw">_</span>) =&gt; (),
            <span class="prelude-val">Err</span>(error) =&gt; {
                <span class="macro">println!</span>(<span class="string">&quot;error: {}&quot;</span>, error);
                <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, input_prompt);
                <span class="kw">continue</span>;
            },
        }

        <span class="kw">match </span>input.trim().parse::&lt;u8&gt;() {
            <span class="prelude-val">Ok</span>(num) =&gt; <span class="kw">if </span>num &gt; <span class="number">0 </span>&amp;&amp; num &lt; <span class="number">6 </span>{
                <span class="kw">return </span>num
            } <span class="kw">else </span>{
                    <span class="macro">println!</span>(<span class="string">&quot;error: number outside valid range&quot;</span>);
                    <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, input_prompt);
                    <span class="kw">continue</span>;
            },
            <span class="prelude-val">Err</span>(error) =&gt; {
                <span class="macro">println!</span>(<span class="string">&quot;error: {}&quot;</span>, error);
                <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, input_prompt);
                <span class="kw">continue</span>;
            },
        };
    }
}

<span class="doccomment">/// User menu for editing the current waveform.
</span><span class="kw">fn </span>edit_waveform(wave_history_pre: Vec&lt;String&gt;, waveform_pre: Vec&lt;f64&gt;, pulse_shape: Vec&lt;f64&gt;, sample_rate_hz: f64) -&gt; (Vec&lt;f64&gt;, Vec&lt;String&gt;) {
    <span class="kw">let </span>(pulse_frequency_hz, duration_sec): (f64, f64) = <span class="kw">loop </span>{
        <span class="kw">let </span>(pulse_frequency_hz_temp, duration_sec_temp): (f64, f64) = get_wave_variables();
        <span class="macro">println!</span>(<span class="string">&quot;\nPulse frequency: {} Hz&quot;</span>, pulse_frequency_hz_temp);
        <span class="macro">println!</span>(<span class="string">&quot;Duration: {} s&quot;</span>, duration_sec_temp);
        <span class="kw">if </span>confirm(<span class="string">&quot;Are these parameters correct? Enter [Y] to confirm, or press any other button to re-enter them.&quot;</span>) {
            <span class="kw">break </span>(pulse_frequency_hz_temp, duration_sec_temp)
        } <span class="kw">else </span>{
            <span class="kw">continue
        </span>}
    };

    <span class="kw">let </span>waveform_new: Vec&lt;f64&gt; = wave_gen(waveform_pre, pulse_shape, sample_rate_hz, pulse_frequency_hz, duration_sec);

    <span class="kw">let </span><span class="kw-2">mut </span>wave_history: Vec&lt;String&gt; = Vec::from(wave_history_pre);
    <span class="kw">let </span>wave_history_new: String = <span class="macro">format!</span>(<span class="string">&quot;    Sampling rate:   {} Hz\n    Pulse frequency: {} Hz\n    Duration:        {} s\n\n&quot;</span>, sample_rate_hz, pulse_frequency_hz, duration_sec);
    wave_history.push(wave_history_new);

    <span class="kw">return </span>(waveform_new, wave_history)
}

<span class="doccomment">/// Get user-defined variables
</span><span class="kw">fn </span>get_wave_variables() -&gt; (f64, f64) {
    <span class="kw">let </span>input_prompt: <span class="kw-2">&amp;</span>str = <span class="string">&quot;Please enter a positive number.&quot;</span>;

    <span class="kw">let </span><span class="kw-2">mut </span>pulse_frequency_hz = String::new();
    <span class="kw">let </span><span class="kw-2">mut </span>duration_sec = String::new();

    <span class="macro">println!</span>(<span class="string">&quot;\nPulse phase (Hz)&quot;</span>);
    <span class="kw">let </span>pulse_frequency_hz: f64 = <span class="kw">loop </span>{
        <span class="kw">match </span>io::stdin().read_line(<span class="kw-2">&amp;mut </span>pulse_frequency_hz) {
            <span class="prelude-val">Ok</span>(<span class="kw">_</span>) =&gt; (),
            <span class="prelude-val">Err</span>(error) =&gt; {
                <span class="macro">println!</span>(<span class="string">&quot;error: {}&quot;</span>, error);
                <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, input_prompt);
                pulse_frequency_hz.clear();
                <span class="kw">continue</span>;
            },
        }

        <span class="kw">match </span>pulse_frequency_hz.trim().parse::&lt;f64&gt;() {
            <span class="prelude-val">Ok</span>(num) =&gt; <span class="kw">break </span>num,
            <span class="prelude-val">Err</span>(error) =&gt; {
                <span class="macro">println!</span>(<span class="string">&quot;error: {}&quot;</span>, error);
                <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, input_prompt);
                pulse_frequency_hz.clear();
                <span class="kw">continue</span>;
            },
        };
    };

    <span class="macro">println!</span>(<span class="string">&quot;Duration (s)&quot;</span>);
    <span class="kw">let </span>duration_sec: f64 = <span class="kw">loop </span>{
        <span class="kw">match </span>io::stdin().read_line(<span class="kw-2">&amp;mut </span>duration_sec) {
            <span class="prelude-val">Ok</span>(<span class="kw">_</span>) =&gt; (),
            <span class="prelude-val">Err</span>(error) =&gt; {
                <span class="macro">println!</span>(<span class="string">&quot;error: {}&quot;</span>, error);
                <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, input_prompt);
                duration_sec.clear();
                <span class="kw">continue</span>;
            },
        }

        <span class="kw">match </span>duration_sec.trim().parse::&lt;f64&gt;() {
            <span class="prelude-val">Ok</span>(num) =&gt; <span class="kw">break </span>num,
            <span class="prelude-val">Err</span>(error) =&gt; {
                <span class="macro">println!</span>(<span class="string">&quot;error: {}&quot;</span>, error);
                <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, input_prompt);
                duration_sec.clear();
                <span class="kw">continue</span>;
            },
        };
    };

    <span class="kw">return </span>(pulse_frequency_hz, duration_sec)
}

<span class="doccomment">/// Constructs a new waveform in which the provided pulse repeats as specified, and appends it to the end of the existing waveform.
</span><span class="kw">fn </span>wave_gen(waveform_pre: Vec&lt;f64&gt;, pulse_shape: Vec&lt;f64&gt;, sample_rate_hz: f64, pulse_frequency_hz: f64, duration_sec: f64) -&gt; Vec&lt;f64&gt; {
    <span class="kw">let </span><span class="kw-2">mut </span>waveform: Vec&lt;f64&gt; = Vec::from(waveform_pre);

    <span class="kw">let </span>period_sec: f64 = <span class="number">1.0</span>/pulse_frequency_hz;
    <span class="kw">let </span>pulse_count_final = (pulse_frequency_hz * duration_sec).ceil() <span class="kw">as </span>u32;
    <span class="kw">let </span>wave_len_final: f64 = (sample_rate_hz * duration_sec).round();

    <span class="kw">let </span><span class="kw-2">mut </span>waveform_new: Vec&lt;f64&gt; = Vec::new();
    <span class="kw">for </span>pulse_count <span class="kw">in </span><span class="number">0</span>..pulse_count_final {
        waveform_new.extend(<span class="kw-2">&amp;</span>pulse_shape);

        <span class="kw">let </span>wave_len_target = f64::min(wave_len_final, (period_sec * sample_rate_hz * (pulse_count <span class="kw">as </span>f64)).round()) <span class="kw">as </span>usize;
        <span class="kw">let </span>zeros: Vec&lt;f64&gt; = <span class="macro">vec!</span>[<span class="number">0.0</span>; wave_len_target - waveform_new.len()];          <span class="comment">// ! This calculation is broken
        </span>waveform_new.extend(zeros)
    }

    waveform.extend(waveform_new);
    waveform
}

<span class="doccomment">/// Prompts user to confirm action before proceeding.
</span><span class="kw">fn </span>confirm(query: <span class="kw-2">&amp;</span>str) -&gt; bool {
    <span class="macro">println!</span>(<span class="string">&quot;{}&quot;</span>, query);

    <span class="kw">let </span><span class="kw-2">mut </span>input = String::new();
    <span class="kw">match </span>io::stdin().read_line(<span class="kw-2">&amp;mut </span>input) {
        <span class="prelude-val">Ok</span>(<span class="kw">_</span>) =&gt; (),
        <span class="prelude-val">Err</span>(<span class="kw">_</span>) =&gt; <span class="kw">return </span><span class="bool-val">false
        </span>}
    input = input.trim().to_lowercase();

    <span class="kw">if </span>input == <span class="string">&quot;y&quot; </span>|| input == <span class="string">&quot;yes&quot; </span>{
        <span class="kw">return </span><span class="bool-val">true
    </span>} <span class="kw">else </span>{
        <span class="kw">return </span><span class="bool-val">false
    </span>}
}


<span class="doccomment">/// Format to store/read settings in JSON file.
</span><span class="attribute">#[derive(Serialize, Deserialize)]
</span><span class="kw">struct </span>Settings {
    pulse_path: String,
    sample_rate_hz: f64,
    phase_duration_presets: Vec&lt;(f64, f64)&gt;,
}
</code></pre></div>
</section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="wave2text" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.66.1 (90743e729 2023-01-10)" ></div></body></html>